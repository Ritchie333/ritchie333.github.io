<!DOCTYPE html>
<html>
<head>
<title>Dynamite Dan: Routine at D677</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html">Dynamite Dan</a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="54901.html">D675</a>
</td>
<td class="up">Up: <a href="../maps/all.html#54903">Map</a></td>
<td class="next">
Next: <a href="54971.html">D6BB</a>
</td>
</tr>
</table>
<div class="description">D677: Copy a sprite's data to a graphic buffer</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="58692.html">E544</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">DE</td>
<td class="register-desc">The sprite data</td>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">The buffer to copy the data to</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="54903"></span>D677</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Get the first byte</td>
</tr>
<tr>
<td class="address-1"><span id="54904"></span>D678</td>
<td class="instruction">AND $0C</td>
<td class="comment-1" rowspan="4">Extract bits 2-3 (the height) and store it <span class="register">C</span>.</td>
</tr>
<tr>
<td class="address-1"><span id="54906"></span>D67A</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="54907"></span>D67B</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="54908"></span>D67C</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="address-1"><span id="54909"></span>D67D</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="2">Copy this plus one into the graphic data.</td>
</tr>
<tr>
<td class="address-1"><span id="54910"></span>D67E</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="54911"></span>D67F</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Move to the next position in the buffer.</td>
</tr>
<tr>
<td class="address-1"><span id="54912"></span>D680</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="3">Extract bits 0-2 (the width) into <span class="register">B</span></td>
</tr>
<tr>
<td class="address-1"><span id="54913"></span>D681</td>
<td class="instruction">AND $03</td>
</tr>
<tr>
<td class="address-1"><span id="54915"></span>D683</td>
<td class="instruction">LD B,A</td>
</tr>
<tr>
<td class="address-1"><span id="54916"></span>D684</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Copy this into the graphic data.</td>
</tr>
<tr>
<td class="address-1"><span id="54917"></span>D685</td>
<td class="instruction">SLA C</td>
<td class="comment-1" rowspan="5">Multiply <span class="register">C</span> by 8 and store it in <span class="register">A</span>.</td>
</tr>
<tr>
<td class="address-1"><span id="54919"></span>D687</td>
<td class="instruction">SLA C</td>
</tr>
<tr>
<td class="address-1"><span id="54921"></span>D689</td>
<td class="instruction">SLA C</td>
</tr>
<tr>
<td class="address-1"><span id="54923"></span>D68B</td>
<td class="instruction">XOR A</td>
</tr>
<tr>
<td class="address-2"><span id="54924"></span>D68C</td>
<td class="instruction">ADD A,C</td>
</tr>
<tr>
<td class="address-1"><span id="54925"></span>D68D</td>
<td class="instruction">DJNZ $D68C</td>
<td class="comment-1" rowspan="1">Loop back while there is more to do.</td>
</tr>
<tr>
<td class="address-1"><span id="54927"></span>D68F</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="2">Put the height in <span class="register">BC</span>.</td>
</tr>
<tr>
<td class="address-1"><span id="54928"></span>D690</td>
<td class="instruction">LD B,$00</td>
</tr>
<tr>
<td class="address-1"><span id="54930"></span>D692</td>
<td class="instruction">LD ($D675),BC</td>
<td class="comment-1" rowspan="1">Store this in <a href="54901.html">D675</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="54934"></span>D696</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="2">Move to the next position in the buffer and store it.</td>
</tr>
<tr>
<td class="address-1"><span id="54935"></span>D697</td>
<td class="instruction">PUSH HL</td>
</tr>
<tr>
<td class="address-1"><span id="54936"></span>D698</td>
<td class="instruction">LD B,$F0</td>
<td class="comment-1" rowspan="5">Initialize the next F0 bytes in the buffer with 0.L</td>
</tr>
<tr>
<td class="address-1"><span id="54938"></span>D69A</td>
<td class="instruction">XOR A</td>
</tr>
<tr>
<td class="address-2"><span id="54939"></span>D69B</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="54940"></span>D69C</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address-1"><span id="54941"></span>D69D</td>
<td class="instruction">DJNZ $D69B</td>
</tr>
<tr>
<td class="address-1"><span id="54943"></span>D69F</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore <span class="register">HL</span> which points to the next place in the buffer.</td>
</tr>
<tr>
<td class="address-1"><span id="54944"></span>D6A0</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Store this.</td>
</tr>
<tr>
<td class="address-1"><span id="54945"></span>D6A1</td>
<td class="instruction">LD BC,$0018</td>
<td class="comment-1" rowspan="1">Increment by 18 for each iteration.</td>
</tr>
<tr>
<td class="address-1"><span id="54948"></span>D6A4</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-1" rowspan="1">Add the next offset.</td>
</tr>
<tr>
<td class="address-1"><span id="54949"></span>D6A5</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Move to the next byte in the sprite data.</td>
</tr>
<tr>
<td class="address-1"><span id="54950"></span>D6A6</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Copy from the sprite data to the buffer.</td>
</tr>
<tr>
<td class="address-1"><span id="54951"></span>D6A7</td>
<td class="instruction">LD BC,($D675)</td>
<td class="comment-1" rowspan="1">Get the length.</td>
</tr>
<tr>
<td class="address-1"><span id="54955"></span>D6AB</td>
<td class="instruction">LDIR</td>
<td class="comment-1" rowspan="1">Do the copy.</td>
</tr>
<tr>
<td class="address-1"><span id="54957"></span>D6AD</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Make <span class="register">DE</span> the next place to copy from.</td>
</tr>
<tr>
<td class="address-1"><span id="54958"></span>D6AE</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore <span class="register">HL</span>.</td>
</tr>
<tr>
<td class="address-1"><span id="54959"></span>D6AF</td>
<td class="instruction">LD BC,$0090</td>
<td class="comment-1" rowspan="1">Increment by 90 for each iteration.</td>
</tr>
<tr>
<td class="address-1"><span id="54962"></span>D6B2</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-1" rowspan="1">Add the next offset.</td>
</tr>
<tr>
<td class="address-1"><span id="54963"></span>D6B3</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Copy from the sprite data to the buffer.</td>
</tr>
<tr>
<td class="address-1"><span id="54964"></span>D6B4</td>
<td class="instruction">LD BC,($D675)</td>
<td class="comment-1" rowspan="1">Get the length.</td>
</tr>
<tr>
<td class="address-1"><span id="54968"></span>D6B8</td>
<td class="instruction">LDIR</td>
<td class="comment-1" rowspan="2">Do the copy and return.</td>
</tr>
<tr>
<td class="address-1"><span id="54970"></span>D6BA</td>
<td class="instruction">RET</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="54901.html">D675</a>
</td>
<td class="up">Up: <a href="../maps/all.html#54903">Map</a></td>
<td class="next">
Next: <a href="54971.html">D6BB</a>
</td>
</tr>
</table>
<footer>
<div class="release"></div>
<div class="copyright">Copyright Rod Bowkett / Mirrorsoft 1985. This dissassembly by Ritchie Swann 2019-2023.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.10.</div>
</footer>
</body>
</html>