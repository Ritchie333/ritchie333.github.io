<!DOCTYPE html>
<html>
<head>
<title>Everyone's A Wally: Routine at A8A0</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="loading" src="../images/loading.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="43069.html">A83D</a>
</td>
<td class="up">Up: <a href="../maps/all.html#43168">Map</a></td>
<td class="next">
Next: <a href="43297.html">A921</a>
</td>
</tr>
</table>
<div class="description">A8A0: Draw a masked object in the sprite buffer</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="60714.html">ED2A</a>, <a href="60810.html">ED8A</a>, <a href="61527.html">F057</a>, <a href="61710.html">F10E</a>, <a href="62027.html">F24B</a>, <a href="62071.html">F277</a>, <a href="62217.html">F309</a>, <a href="62333.html">F37D</a>, <a href="62379.html">F3AB</a>, <a href="62473.html">F409</a>, <a href="62621.html">F49D</a>, <a href="62723.html">F503</a>, <a href="62961.html">F5F1</a>, <a href="63092.html">F674</a>, <a href="63212.html">F6EC</a> and <a href="63673.html">F8B9</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">ID of the graphic to update</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="43168"></span>
<div class="comments">
<div class="paragraph">
The co-ordinates to update are stored in <a href="43064.html">A838</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="43168"></span>A8A0</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Exchange main registers.</td>
</tr>
<tr>
<td class="address-1"><span id="43169"></span>A8A1</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Remember <span class="register">AF</span>.</td>
</tr>
<tr>
<td class="address-1"><span id="43170"></span>A8A2</td>
<td class="instruction">LD ($A83B),SP</td>
<td class="comment-1" rowspan="1">Store the stack pointer in <a href="43067.html">A83B</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="43174"></span>A8A6</td>
<td class="instruction">LD SP,$8378</td>
<td class="comment-1" rowspan="1">Set the stack pointer to the start of the object graphics. (<a href="33656.html">8378</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="43177"></span>A8A9</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="2">Put the sprite ID in <span class="register">HL</span>.</td>
</tr>
<tr>
<td class="address-1"><span id="43178"></span>A8AA</td>
<td class="instruction">LD H,$00</td>
</tr>
<tr>
<td class="address-1"><span id="43180"></span>A8AC</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-1" rowspan="5">Multiply by 32.</td>
</tr>
<tr>
<td class="address-1"><span id="43181"></span>A8AD</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="address-1"><span id="43182"></span>A8AE</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="address-1"><span id="43183"></span>A8AF</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="address-1"><span id="43184"></span>A8B0</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="address-1"><span id="43185"></span>A8B1</td>
<td class="instruction">ADD HL,SP</td>
<td class="comment-1" rowspan="2">Use this to set the stack pointer at the graphic data for this object.</td>
</tr>
<tr>
<td class="address-1"><span id="43186"></span>A8B2</td>
<td class="instruction">LD SP,HL</td>
</tr>
<tr>
<td class="address-1"><span id="43187"></span>A8B3</td>
<td class="instruction">LD A,($A838)</td>
<td class="comment-1" rowspan="2">Put the X co-ordinate in <span class="register">B</span>.</td>
</tr>
<tr>
<td class="address-1"><span id="43190"></span>A8B6</td>
<td class="instruction">LD B,A</td>
</tr>
<tr>
<td class="address-1"><span id="43191"></span>A8B7</td>
<td class="instruction">AND $07</td>
<td class="comment-1" rowspan="1">Get the bottom 3 bytes, which represents the frame number.</td>
</tr>
<tr>
<td class="address-1"><span id="43193"></span>A8B9</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="3">Add 1, and set this in A8E0 and A8FC which modifies later routines.</td>
</tr>
<tr>
<td class="address-1"><span id="43194"></span>A8BA</td>
<td class="instruction">LD ($A8E0),A</td>
</tr>
<tr>
<td class="address-1"><span id="43197"></span>A8BD</td>
<td class="instruction">LD ($A8FC),A</td>
</tr>
<tr>
<td class="address-1"><span id="43200"></span>A8C0</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="6">Put the bottom 5 bits, which represents the byte, in EFAF. This changes the logic in the routine to draw the fountain in the town square at <a href="61329.html">EF91</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="43201"></span>A8C1</td>
<td class="instruction">AND $F8</td>
</tr>
<tr>
<td class="address-1"><span id="43203"></span>A8C3</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="43204"></span>A8C4</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="43205"></span>A8C5</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="43206"></span>A8C6</td>
<td class="instruction">LD ($EFAF),A</td>
</tr>
<tr>
<td class="address-1"><span id="43209"></span>A8C9</td>
<td class="instruction">ADD A,$02</td>
<td class="comment-1" rowspan="2">Add 2 to the byte and store it in <span class="register">E</span>.</td>
</tr>
<tr>
<td class="address-1"><span id="43211"></span>A8CB</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="43212"></span>A8CC</td>
<td class="instruction">LD C,$10</td>
<td class="comment-1" rowspan="1">10 rows to update.</td>
</tr>
<tr>
<td class="address-1"><span id="43214"></span>A8CE</td>
<td class="instruction">LD A,($A839)</td>
<td class="comment-1" rowspan="1">Get the Y co-ordinate.</td>
</tr>
<tr>
<td class="address-1"><span id="43217"></span>A8D1</td>
<td class="instruction">SUB $40</td>
<td class="comment-1" rowspan="1">Subtract 40 to get an offset in the sprite buffer.</td>
</tr>
<tr>
<td class="address-1"><span id="43219"></span>A8D3</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="2">Put this in <span class="register">HL</span>.</td>
</tr>
<tr>
<td class="address-1"><span id="43220"></span>A8D4</td>
<td class="instruction">LD H,$00</td>
</tr>
<tr>
<td class="address-1"><span id="43222"></span>A8D6</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-1" rowspan="5">Multiply by 32 to get a row offset.</td>
</tr>
<tr>
<td class="address-1"><span id="43223"></span>A8D7</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="address-1"><span id="43224"></span>A8D8</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="address-1"><span id="43225"></span>A8D9</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="address-1"><span id="43226"></span>A8DA</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="address-1"><span id="43227"></span>A8DB</td>
<td class="instruction">LD D,$6B</td>
<td class="comment-1" rowspan="1">Set the high byte of <span class="register">DE</span> to an offset in the sprite buffer. (<a href="27392.html">6B00</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="43229"></span>A8DD</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-1" rowspan="1">Add this.</td>
</tr>
<tr>
<td class="address-2"><span id="43230"></span>A8DE</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Get the next value (the mask) in <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="43231"></span>
<div class="comments">
<div class="paragraph">
If this is not frame 0, it doesn't sit on a byte boundary and bits need shifting forwards.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="43231"></span>A8DF</td>
<td class="instruction">LD B,$00</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> to the number of frames to loop around. (This code is modified earlier)</td>
</tr>
<tr>
<td class="address-1"><span id="43233"></span>A8E1</td>
<td class="instruction">DEC B</td>
<td class="comment-1" rowspan="2">If this is frame 0, there is one less byte to update.</td>
</tr>
<tr>
<td class="address-1"><span id="43234"></span>A8E2</td>
<td class="instruction">JR Z,$A8F0</td>
</tr>
<tr>
<td class="address-1"><span id="43236"></span>A8E4</td>
<td class="instruction">SCF</td>
<td class="comment-1" rowspan="1">Set the carry flag, to use in rotating bits.</td>
</tr>
<tr>
<td class="address-1"><span id="43237"></span>A8E5</td>
<td class="instruction">LD A,$FF</td>
<td class="comment-1" rowspan="1">Start with a mask of FF ie: all bits on.</td>
</tr>
<tr>
<td class="address-2"><span id="43239"></span>A8E7</td>
<td class="instruction">RR E</td>
<td class="comment-1" rowspan="2">Rotate <span class="register">E</span> and <span class="register">D</span>, respecting carry.</td>
</tr>
<tr>
<td class="address-1"><span id="43241"></span>A8E9</td>
<td class="instruction">RR D</td>
</tr>
<tr>
<td class="address-1"><span id="43243"></span>A8EB</td>
<td class="instruction">RRA</td>
<td class="comment-1" rowspan="1">Rotate <span class="register">A</span>, respecting carry.</td>
</tr>
<tr>
<td class="address-1"><span id="43244"></span>A8EC</td>
<td class="instruction">DJNZ $A8E7</td>
<td class="comment-1" rowspan="1">Loop until we get to the right frame number.</td>
</tr>
<tr>
<td class="address-1"><span id="43246"></span>A8EE</td>
<td class="instruction">AND (HL)</td>
<td class="comment-1" rowspan="2">Do a logical AND of the mask in <span class="register">A</span> against the byte in the sprite buffer.</td>
</tr>
<tr>
<td class="address-1"><span id="43247"></span>A8EF</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-2"><span id="43248"></span>A8F0</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="1">Move back a byte.</td>
</tr>
<tr>
<td class="address-1"><span id="43249"></span>A8F1</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="3">Do a logical AND of the mask in <span class="register">D</span> against the byte in the sprite buffer.</td>
</tr>
<tr>
<td class="address-1"><span id="43250"></span>A8F2</td>
<td class="instruction">AND D</td>
</tr>
<tr>
<td class="address-1"><span id="43251"></span>A8F3</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="43252"></span>A8F4</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="1">Move back a byte.</td>
</tr>
<tr>
<td class="address-1"><span id="43253"></span>A8F5</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="3">Do a logical AND of the mask in <span class="register">E</span> against the byte in the sprite buffer.</td>
</tr>
<tr>
<td class="address-1"><span id="43254"></span>A8F6</td>
<td class="instruction">AND E</td>
</tr>
<tr>
<td class="address-1"><span id="43255"></span>A8F7</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="43256"></span>A8F8</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="2">Move forward to the next byte in the buffer.</td>
</tr>
<tr>
<td class="address-1"><span id="43257"></span>A8F9</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address-1"><span id="43258"></span>A8FA</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Get the next value (the data) in <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="address-1"><span id="43259"></span>A8FB</td>
<td class="instruction">LD B,$00</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> to the number of frames to loop around. (This code is modified earlier)</td>
</tr>
<tr>
<td class="address-1"><span id="43261"></span>A8FD</td>
<td class="instruction">DEC B</td>
<td class="comment-1" rowspan="2">If this is frame 0, there is one less byte to update.</td>
</tr>
<tr>
<td class="address-1"><span id="43262"></span>A8FE</td>
<td class="instruction">JR Z,$A90A</td>
</tr>
<tr>
<td class="address-1"><span id="43264"></span>A900</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Start with data of 0 ie: all bits off</td>
</tr>
<tr>
<td class="address-2"><span id="43265"></span>A901</td>
<td class="instruction">SRL E</td>
<td class="comment-1" rowspan="1">Shift <span class="register">E</span> to the right, putting 0 on bit 7.</td>
</tr>
<tr>
<td class="address-1"><span id="43267"></span>A903</td>
<td class="instruction">RR D</td>
<td class="comment-1" rowspan="1">Rotate <span class="register">D</span> respecting carry.</td>
</tr>
<tr>
<td class="address-1"><span id="43269"></span>A905</td>
<td class="instruction">RRA</td>
<td class="comment-1" rowspan="1">Rotate <span class="register">A</span> repsecting carry.</td>
</tr>
<tr>
<td class="address-1"><span id="43270"></span>A906</td>
<td class="instruction">DJNZ $A901</td>
<td class="comment-1" rowspan="1">Loop until we get to the right frame number.</td>
</tr>
<tr>
<td class="address-1"><span id="43272"></span>A908</td>
<td class="instruction">OR (HL)</td>
<td class="comment-1" rowspan="2">Do a logical OR of the data in <span class="register">A</span> against the byte in the sprite buffer.</td>
</tr>
<tr>
<td class="address-1"><span id="43273"></span>A909</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-2"><span id="43274"></span>A90A</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="1">Move back a byte.</td>
</tr>
<tr>
<td class="address-1"><span id="43275"></span>A90B</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="3">Do a logical OR of the data in <span class="register">D</span> against the byte in the sprite buffer.</td>
</tr>
<tr>
<td class="address-1"><span id="43276"></span>A90C</td>
<td class="instruction">OR D</td>
</tr>
<tr>
<td class="address-1"><span id="43277"></span>A90D</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="43278"></span>A90E</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="1">Move back a byte.</td>
</tr>
<tr>
<td class="address-1"><span id="43279"></span>A90F</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="3">Do a logical OR of the data in <span class="register">D</span> against the byte in the sprite buffer.</td>
</tr>
<tr>
<td class="address-1"><span id="43280"></span>A910</td>
<td class="instruction">OR E</td>
</tr>
<tr>
<td class="address-1"><span id="43281"></span>A911</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="43282"></span>A912</td>
<td class="instruction">LD DE,$0022</td>
<td class="comment-1" rowspan="2">Move forward a row and two columns.</td>
</tr>
<tr>
<td class="address-1"><span id="43285"></span>A915</td>
<td class="instruction">ADD HL,DE</td>
</tr>
<tr>
<td class="address-1"><span id="43286"></span>A916</td>
<td class="instruction">DEC C</td>
<td class="comment-1" rowspan="1">Decrement the row count.</td>
</tr>
<tr>
<td class="address-1"><span id="43287"></span>A917</td>
<td class="instruction">JP NZ,$A8DE</td>
<td class="comment-1" rowspan="1">Loop while there are more rows to draw.</td>
</tr>
<tr>
<td class="address-1"><span id="43290"></span>A91A</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Restore main registers.</td>
</tr>
<tr>
<td class="address-1"><span id="43291"></span>A91B</td>
<td class="instruction">LD SP,($A83B)</td>
<td class="comment-1" rowspan="1">Restore the stack pointer.</td>
</tr>
<tr>
<td class="address-1"><span id="43295"></span>A91F</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="2">Restore <span class="register">AF</span> and return.</td>
</tr>
<tr>
<td class="address-1"><span id="43296"></span>A920</td>
<td class="instruction">RET</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="43069.html">A83D</a>
</td>
<td class="up">Up: <a href="../maps/all.html#43168">Map</a></td>
<td class="next">
Next: <a href="43297.html">A921</a>
</td>
</tr>
</table>
<footer>
<div class="release"></div>
<div class="copyright">(c) 1985 Mikro-Gen (code and graphics), 2013-2023 Ritchie Swann / Paul Maddern (this disassembly)</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 9.0.</div>
</footer>
</body>
</html>